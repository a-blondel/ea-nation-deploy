services:
  postgres-mohh:
    image: postgres:17.0
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
      - PGDATA=/var/lib/postgresql/data/mohh
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT}:5432"

  dns:
    build: ./dns-server
    restart: unless-stopped
    ports:
      - "53:53/udp"
      - "53:53/tcp"

  ea-tos-nwc-bundle-http:
    build: ./ea-tos-server
    image: ea-tos-nwc-bundle-server
    restart: unless-stopped
    command: start-http
    volumes:
      - /var/www/certs:/app/certs
    ports:
      - "80:80"

  ea-tos-nwc-bundle-https:
    image: ea-tos-nwc-bundle-server
    restart: unless-stopped
    command: start-https
    volumes:
      - /var/www/certs:/app/certs
    ports:
      - "443:443"

  mohh-master-server:
    image: ghcr.io/a-blondel/mohh-master-server/mohh-master-server:latest
    restart: unless-stopped
    environment:
      - DB_URL=jdbc:postgresql://postgres-mohh:5432/${DB_NAME}
      - DB_USERNAME
      - DB_PASSWORD
      - TCP_HOST_IP
      - TCP_DEBUG_ENABLED=false
      - TCP_DEBUG_EXCLUSIONS=~png,+snp
      - SSL_DEBUG_ENABLED=false
      - TOS_ENABLED=false
      - TOS_HOSTNAME=http://ablondel.ddns.net
      - LOGS=/var/log/mohh
    volumes:
      - app_logs:/var/log/mohh
    ports:
      - "8080:8080" # master server http
      - "11180:11180" # mohh psp pal tcp
      - "11181:11181" # mohh psp pal ssl
      - "11190:11190" # mohh psp ntsc tcp
      - "11191:11191" # mohh psp ntsc ssl
      - "21180:21180" # mohh2 psp pal tcp
      - "21181:21181" # mohh2 psp pal ssl
      - "21190:21190" # mohh2 psp ntsc tcp
      - "21191:21191" # mohh2 psp ntsc ssl
      - "21170:21170" # mohh2 wii pal tcp
      - "21171:21171" # mohh2 wii pal ssl
      - "21120:21120" # mohh2 wii ntsc tcp
      - "21121:21121" # mohh2 wii ntsc ssl

  mohh-gps:
    image: ghcr.io/a-blondel/mohh-gps-docker/mohh-gps-docker:latest
    privileged: true
    environment:
      - GPS_NAME=${GPS_NAME}
      - GPS_PWD=${GPS_PWD}
      - GPS_ADM_PWD=${GPS_ADM_PWD}
      - GPS_PORT=3658
      - GPS_INSTANCES=10
    ports:
      - "3658-3667:3658-3667/udp" # GPS UDP ports
      - "3688-3697:3688-3697/udp" # GPS UDP ping ports
    extra_hosts:
      - "pspmoh07.ea.com:${TCP_HOST_IP}"

volumes:
  db_data:
  app_logs:
